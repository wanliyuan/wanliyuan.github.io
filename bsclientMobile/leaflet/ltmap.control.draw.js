(function(B,A,C){LTMap.drawVersion="1.0";LTMap.drawLocal={draw:{toolbar:{actions:{title:"取消绘制",text:"取消"},undo:{title:"删除最后一个点",text:"删除最后点"},buttons:{polyline:"绘制线",polygon:"绘制面",rectangle:"绘制矩形",circle:"绘制圆",marker:"标注"}},handlers:{circle:{tooltip:{start:"单击鼠标左键拖拽绘制圆."}},marker:{tooltip:{start:"单击鼠标左键标注."}},polygon:{tooltip:{start:"单击鼠标左键绘制多边形.",cont:"单击鼠标左键继续绘制.",end:"双击完成绘制或点击最后一个点完成绘制."}},polyline:{error:"<strong>错误:</strong> shape edges cannot cross!",tooltip:{start:"单击鼠标左键开始绘制线.",cont:"单击鼠标左键继续绘制线.",end:"双击完成绘制或点击最后一个点完成绘制."}},rectangleZoom:{tooltip:{start:"单击鼠标左键拖拽拉框.",end:"释放鼠标结束拉框."}},rectangle:{tooltip:{start:"单击鼠标左键拖拽绘制矩形."}},simpleshape:{tooltip:{end:"释放鼠标完成绘制."}}}},edit:{toolbar:{actions:{save:{title:"保存编辑.",text:"保存"},cancel:{title:"取消编辑, 取消所有的更改.",text:"取消"}},buttons:{edit:"编辑.",editDisabled:"没有可编辑的图层元素.",remove:"删除元素.",removeDisabled:"没有可删除的图层元素."}},handlers:{edit:{tooltip:{subtext:"点击取消,取消修改.",text:"拖拽锚点,移动或修改图层元素."}},remove:{tooltip:{text:"点击图层元素来移除图层元素."}}}}};LTMap.Draw={};LTMap.Draw.Feature=LTMap.Handler.extend({includes:LTMap.Mixin.Events,initialize:function(E,D){this._map=E;this._container=E._container;this._overlayPane=E._panes.overlayPane;this._popupPane=E._panes.popupPane;if(D&&D.shapeOptions){D.shapeOptions=LTMap.Util.extend({},this.options.shapeOptions,D.shapeOptions)}LTMap.setOptions(this,D)},enable:function(){if(this._enabled){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:drawstart",{layerType:this.type});LTMap.Handler.prototype.enable.call(this)},disable:function(){if(!this._enabled){return}LTMap.Handler.prototype.disable.call(this);this._map.fire("draw:drawstop",{layerType:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var D=this._map;if(D){LTMap.DomUtil.disableTextSelection();D.getContainer().focus();this._tooltip=new LTMap.Tooltip(this._map);LTMap.DomEvent.on(this._container,"keyup",this._cancelDrawing,this)}},removeHooks:function(){if(this._map){LTMap.DomUtil.enableTextSelection();this._tooltip.dispose();this._tooltip=null;LTMap.DomEvent.off(this._container,"keyup",this._cancelDrawing,this)}},setOptions:function(D){LTMap.setOptions(this,D)},_fireCreatedEvent:function(D){this._map.fire("draw:created",{layer:D,layerType:this.type,drawTag:this.options.drawTag})},_cancelDrawing:function(D){if(D.keyCode===27){this.disable()}}});LTMap.Draw.Polyline=LTMap.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:LTMap.Polyline,options:{allowIntersection:true,repeatMode:false,drawError:{color:"#b00b00",timeout:2500},icon:new LTMap.DivIcon({iconSize:new LTMap.Point(8,8),className:"ltmap-div-icon ltmap-editing-icon"}),guidelineDistance:20,maxGuideLineLength:4000,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:false,clickable:true},metric:false,showLength:false,zIndexOffset:2000},initialize:function(E,D){this.options.drawError.message=LTMap.drawLocal.draw.handlers.polyline.error;if(D&&D.drawError){D.drawError=LTMap.Util.extend({},this.options.drawError,D.drawError)}this.type=LTMap.Draw.Polyline.TYPE;LTMap.Draw.Feature.prototype.initialize.call(this,E,D)},addHooks:function(){LTMap.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new LTMap.LayerGroup();this._map.addLayer(this._markerGroup);this._poly=new LTMap.Polyline([],this.options.shapeOptions);this._tooltip.updateContent(this._getTooltipText());if(!this._mouseMarker){this._mouseMarker=LTMap.marker(this._map.getCenter(),{icon:LTMap.divIcon({className:"ltmap-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("mousedown",this._onMouseDown,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this).on("mouseup",this._onMouseUp,this).on("zoomend",this._onZoomEnd,this)}},removeHooks:function(){LTMap.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._poly);delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseup",this._onMouseUp,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this)},deleteLastVertex:function(){if(this._markers.length<=1){return}var F=this._markers.pop(),E=this._poly,D=this._poly.spliceLatLngs(E.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(F);if(E.getLatLngs().length<2){this._map.removeLayer(E)}this._vertexChanged(D,false)},addVertex:function(D){var E=this._markers.length;if(E>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(D)){this._showErrorTooltip();return}else{if(this._errorShown){this._hideErrorTooltip()}}this._markers.push(this._createMarker(D));this._poly.addLatLng(D);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(D,true)},_finishShape:function(){var D=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],true);if((!this.options.allowIntersection&&D)||!this._shapeIsValid()){this._showErrorTooltip();return}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_shapeIsValid:function(){return true},_onZoomEnd:function(){this._updateGuide()},_onMouseMove:function(E){var F=E.layerPoint,D=E.latlng;this._currentLatLng=D;this._updateTooltip(D);this._updateGuide(F);this._mouseMarker.setLatLng(D);LTMap.DomEvent.preventDefault(E.originalEvent)},_vertexChanged:function(D,E){this._updateFinishHandler();this._updateRunningMeasure(D,E);this._clearGuides();this._updateTooltip()},_onMouseDown:function(E){var D=E.originalEvent;this._mouseDownOrigin=LTMap.point(D.clientX,D.clientY)},_onMouseUp:function(E){if(this._mouseDownOrigin){var D=LTMap.point(E.originalEvent.clientX,E.originalEvent.clientY).distanceTo(this._mouseDownOrigin);if(Math.abs(D)<9*(B.devicePixelRatio||1)){this.addVertex(E.latlng)}}this._mouseDownOrigin=null},_updateFinishHandler:function(){var D=this._markers.length;if(D>1){this._markers[D-1].on("dblclick",this._finishShape,this)}if(D>2){this._markers[D-2].off("dblclick",this._finishShape,this)}},_createMarker:function(D){var E=new LTMap.Marker(D,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});this._markerGroup.addLayer(E);return E},_updateGuide:function(E){var D=this._markers.length;if(D>0){E=E||this._map.latLngToLayerPoint(this._currentLatLng);this._clearGuides();this._drawGuide(this._map.latLngToLayerPoint(this._markers[D-1].getLatLng()),E)}},_updateTooltip:function(D){var E=this._getTooltipText();if(D){this._tooltip.updatePosition(D)}if(!this._errorShown){this._tooltip.updateContent(E)}},_drawGuide:function(L,F){var I=Math.floor(Math.sqrt(Math.pow((F.x-L.x),2)+Math.pow((F.y-L.y),2))),J=this.options.guidelineDistance,G=this.options.maxGuideLineLength,D=I>G?I-G:J,H,E,K;if(!this._guidesContainer){this._guidesContainer=LTMap.DomUtil.create("div","ltmap-draw-guides",this._overlayPane)}for(;D<I;D+=this.options.guidelineDistance){H=D/I;E={x:Math.floor((L.x*(1-H))+(H*F.x)),y:Math.floor((L.y*(1-H))+(H*F.y))};K=LTMap.DomUtil.create("div","ltmap-draw-guide-dash",this._guidesContainer);K.style.backgroundColor=!this._errorShown?this.options.shapeOptions.color:this.options.drawError.color;LTMap.DomUtil.setPosition(K,E)}},_updateGuideColor:function(E){if(this._guidesContainer){for(var D=0,F=this._guidesContainer.childNodes.length;D<F;D++){this._guidesContainer.childNodes[D].style.backgroundColor=E}}},_clearGuides:function(){if(this._guidesContainer){while(this._guidesContainer.firstChild){this._guidesContainer.removeChild(this._guidesContainer.firstChild)}}},_getTooltipText:function(){var E=this.options.showLength,F,D;if(this._markers.length===0){F={text:LTMap.drawLocal.draw.handlers.polyline.tooltip.start}}else{D=E?this._getMeasurementString():"";if(this._markers.length===1){F={text:LTMap.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:D}}else{F={text:LTMap.drawLocal.draw.handlers.polyline.tooltip.end,subtext:D}}}return F},_updateRunningMeasure:function(D,H){var E=this._markers.length,F,G;if(this._markers.length===1){this._measurementRunningTotal=0}else{F=E-(H?2:1);G=D.distanceTo(this._markers[F].getLatLng());this._measurementRunningTotal+=G*(H?1:-1)}},_getMeasurementString:function(){var F=this._currentLatLng,D=this._markers[this._markers.length-1].getLatLng(),E;E=this._measurementRunningTotal+F.distanceTo(D);return LTMap.GeometryUtil.readableDistance(E,this.options.metric)},_showErrorTooltip:function(){this._errorShown=true;this._tooltip.showAsError().updateContent({text:this.options.drawError.message});this._updateGuideColor(this.options.drawError.color);this._poly.setStyle({color:this.options.drawError.color});this._clearHideErrorTimeout();this._hideErrorTimeout=setTimeout(LTMap.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=false;this._clearHideErrorTimeout();this._tooltip.removeError().updateContent(this._getTooltipText());this._updateGuideColor(this.options.shapeOptions.color);this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){if(this._hideErrorTimeout){clearTimeout(this._hideErrorTimeout);this._hideErrorTimeout=null}},_cleanUpShape:function(){if(this._markers.length>1){this._markers[this._markers.length-1].off("dblclick",this._finishShape,this)}},open:function(){this.enable()},close:function(){this.disable()},_fireCreatedEvent:function(){var D=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);LTMap.Draw.Feature.prototype._fireCreatedEvent.call(this,D)}});LTMap.Draw.Polygon=LTMap.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:LTMap.Polygon,options:{showArea:false,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true}},initialize:function(E,D){LTMap.Draw.Polyline.prototype.initialize.call(this,E,D);this.type=LTMap.Draw.Polygon.TYPE},_updateFinishHandler:function(){var D=this._markers.length;if(D===1){this._markers[0].on("click",this._finishShape,this)}if(D>2){this._markers[D-1].on("dblclick",this._finishShape,this);if(D>3){this._markers[D-2].off("dblclick",this._finishShape,this)}}},_getTooltipText:function(){var E,D;if(this._markers.length===0){E=LTMap.drawLocal.draw.handlers.polygon.tooltip.start}else{if(this._markers.length<3){E=LTMap.drawLocal.draw.handlers.polygon.tooltip.cont}else{E=LTMap.drawLocal.draw.handlers.polygon.tooltip.end;D=this._getMeasurementString()}}return{text:E,subtext:D}},_getMeasurementString:function(){var D=this._area;if(!D){return null}return LTMap.GeometryUtil.readableArea(D,this.options.metric)},_shapeIsValid:function(){return this._markers.length>=3},_vertexChanged:function(D,E){var F;if(!this.options.allowIntersection&&this.options.showArea){F=this._poly.getLatLngs();this._area=LTMap.GeometryUtil.geodesicArea(F)}LTMap.Draw.Polyline.prototype._vertexChanged.call(this,D,E)},_cleanUpShape:function(){var D=this._markers.length;if(D>0){this._markers[0].off("click",this._finishShape,this);if(D>2){this._markers[D-1].off("dblclick",this._finishShape,this)}}},open:function(){this.enable()},close:function(){this.disable()}});LTMap.MeasureArea=LTMap.Draw.Polygon.extend({statics:{TYPE:"area"},options:{showArea:true,metric:true,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true}},Poly:LTMap.Polygon,initialize:function(E,D){this.type=LTMap.MeasureArea.TYPE;LTMap.Draw.Polyline.prototype.initialize.call(this,E,D)},addHooks:function(){LTMap.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new LTMap.LayerGroup();this._map.addLayer(this._markerGroup);this._poly=new LTMap.Polygon([],this.options.shapeOptions);this._tooltip.updateContent(this._getTooltipText());if(!this._mouseMarker){this._mouseMarker=LTMap.marker(this._map.getCenter(),{icon:LTMap.divIcon({className:"ltmap-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("mousedown",this._onMouseDown,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this).on("mouseup",this._onMouseUp,this).on("zoomend",this._onZoomEnd,this)}if(!this._markerGroupTemp){this._markerGroupTemp=new LTMap.LayerGroup();this._map.addLayer(this._markerGroupTemp)}if(!this._markerAarrys){this._markerAarrys=[]}if(!this._polylineGroupTemp){this._polylineGroupTemp=new LTMap.LayerGroup();this._map.addLayer(this._polylineGroupTemp)}},removeHooks:function(){LTMap.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._markerGroupTemp);delete this._markerGroupTemp;this._map.removeLayer(this._polylineGroupTemp);delete this._polylineGroupTemp;delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseup",this._onMouseUp,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this);this._markerAarrys.length=0},open:function(){this.enable()},close:function(){this.disable();if(this.i!=0){this.i=0}},_createMarker:function(D){var E=new LTMap.marker(D,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});this._markerGroup.addLayer(E);this._markerGroupTemp.addLayer(E);this._markerAarrys.push(E);return E},addVertex:function(E){var F=this._markers.length;if(F>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(E)){this._showErrorTooltip();return}else{if(this._errorShown){this._hideErrorTooltip()}}this._markers.push(this._createMarker(E));this._poly.addLatLng(E);if(this._poly.getLatLngs().length===2){this._polylineGroupTemp.addLayer(this._poly)}this._vertexChanged(E,true);var D=new LTMap.marker(E,{zIndexOffset:this.options.zIndexOffset*2});var G;if(this._markers.length==1){G=new LTMap.DivIcon({iconSize:new LTMap.Point(35,12),iconAnchor:[-8,25],className:"myicon",html:"<span>起点</span>",})}if(this._markers.length==2){G=new LTMap.DivIcon({iconAnchor:[-8,25],className:"myicon1",})}if(this._markers.length>=3){G=new LTMap.DivIcon({iconAnchor:[-8,25],className:"myicon",html:"<span>"+this._getMeasurementString()+"</span>",})}D.setIcon(G);this._markerAarrys.push(D);this._markerGroupTemp.addLayer(D)},_vertexChanged:function(D,E){var F;if(this.options.showArea){F=this._poly.getLatLngs();this._area=LTMap.GeometryUtil.geodesicArea(F)}LTMap.Draw.Polyline.prototype._vertexChanged.call(this,D,E)},_cleanUpShape:function(){var D=this._markers.length;if(D>0){this._markers[0].off("click",this._finishShape,this);if(D>2){this._markers[D-1].off("dblclick",this._finishShape,this)}}},_finishShape:function(){var F=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],true);if((!this.options.allowIntersection&&F)||!this._shapeIsValid()){this._showErrorTooltip();return}var G=this._markerAarrys.length-1;if(G>=0){var E=new LTMap.DivIcon({iconAnchor:[-8,25],className:"myicon",html:"<span><span>总面积是：</span>"+this._getMeasurementString()+"</span>",});this._markerAarrys[this._markerAarrys.length-1].setIcon(E)}var D=LTMap.marker(this._markerAarrys[G].getLatLng(),{icon:new LTMap.DivIcon({iconAnchor:[20,10],className:"finish_distance",html:"<span>x</span>",}),zIndexOffset:30000}).addTo(this._markerGroupTemp);this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},clear:function(){if(this._tempLayerGroup){this._tempLayerGroup.clearLayers();this.i=0}},_getTooltipText:function(){var F=this.options.showArea,E,D;if(this._markers.length===0){E={text:"单击地图确定起点"}}else{if(this._markers.length==1){E={text:"单击地图继续"}}else{D=F?this._getMeasurementString():"";E={text:"双击地图或者单击最后一个点结束",subtext:D}}}return E},_getMeasurementString:function(){var D=this._area;if(!D){return null}return LTMap.GeometryUtil.readableArea(D,this.options.metric)},_fireCreatedEvent:function(){if(!this.i){this.i=0}var D=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);D.id=this.i;if(!this._tempLayerGroup){this._tempLayerGroup=LTMap.layerGroup()}var E=this;this._markerGroupTemp.eachLayer(function(H){var K=H._latlng;var G=H.options.icon.options.className;var F=H._icon.innerHTML;var N=H.options.zIndexOffset;var J,I;if(LTMap.Browser.ie){J=parseInt(H._icon.currentStyle.marginLeft);I=parseInt(H._icon.currentStyle.marginTop)}else{J=H._icon.offsetLeft;I=H._icon.offsetTop}var L=H._icon.offsetHeight;var O=H._icon.offsetWidth;var M=LTMap.marker(K,{icon:new LTMap.DivIcon({className:G,iconAnchor:[-J,-I],html:F,iconSize:[L,O]}),zIndexOffset:N});M.id=E.i;if(F=="<SPAN>x</SPAN>"||F=="<span>x</span>"){M.on("click",function(){E._tempLayerGroup.eachLayer(function(P){if(P.id==M.id){E._tempLayerGroup.removeLayer(P)}})})}E._tempLayerGroup.addLayer(M)});this._tempLayerGroup.addLayer(D);this.type=LTMap.MeasureArea.TYPE;LTMap.Draw.Feature.prototype._fireCreatedEvent.call(this,this._tempLayerGroup);this.i++}});LTMap.MeasureDistance=LTMap.Draw.Polyline.extend({statics:{TYPE:"distance"},options:{repeatMode:true,metric:true,showLength:true},initialize:function(E,D){this.type=LTMap.MeasureDistance.TYPE;LTMap.Draw.Polyline.prototype.initialize.call(this,E,D)},addHooks:function(){LTMap.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new LTMap.LayerGroup();this._map.addLayer(this._markerGroup);this._poly=new LTMap.Polyline([],this.options.shapeOptions);this._tooltip.updateContent(this._getTooltipText());if(!this._mouseMarker){this._mouseMarker=LTMap.marker(this._map.getCenter(),{icon:LTMap.divIcon({className:"ltmap-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("mousedown",this._onMouseDown,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this).on("mouseup",this._onMouseUp,this).on("zoomend",this._onZoomEnd,this)}if(!this._markerGroupTemp){this._markerGroupTemp=new LTMap.LayerGroup();this._map.addLayer(this._markerGroupTemp)}if(!this._markerAarrys){this._markerAarrys=[]}if(!this._polylineGroupTemp){this._polylineGroupTemp=new LTMap.LayerGroup();this._map.addLayer(this._polylineGroupTemp)}},removeHooks:function(){LTMap.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._markerGroupTemp);delete this._markerGroupTemp;this._map.removeLayer(this._polylineGroupTemp);delete this._polylineGroupTemp;delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseup",this._onMouseUp,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this);this._markerAarrys.length=0},open:function(){this.enable()},close:function(){this.disable();if(this.i!=0){this.i=0}},_createMarker:function(E){var F=new LTMap.marker(E,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});var D=new LTMap.marker(E,{zIndexOffset:this.options.zIndexOffset*2});var G;if(this._markers.length==0){G=new LTMap.DivIcon({iconSize:new LTMap.Point(35,12),iconAnchor:[-8,25],className:"myicon",html:"<span>起点</span>",})}if(this._markers.length>=1){G=new LTMap.DivIcon({iconAnchor:[-8,25],className:"myicon",html:"<span>"+this._getMeasurementString()+"</span>",})}D.setIcon(G);this._markerGroup.addLayer(F);this._markerAarrys.push(F);this._markerAarrys.push(D);this._markerGroupTemp.addLayer(D);this._markerGroupTemp.addLayer(F);return F},addVertex:function(D){var E=this._markers.length;if(E>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(D)){this._showErrorTooltip();return}else{if(this._errorShown){this._hideErrorTooltip()}}this._markers.push(this._createMarker(D));this._poly.addLatLng(D);if(this._poly.getLatLngs().length===2){this._polylineGroupTemp.addLayer(this._poly)}this._vertexChanged(D,true)},_finishShape:function(){var F=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],true);if((!this.options.allowIntersection&&F)||!this._shapeIsValid()){this._showErrorTooltip();return}var G=this._markerAarrys.length-1;if(G>=0){var E=new LTMap.DivIcon({iconAnchor:[-8,25],className:"myicon",html:"<span><span>总长是：</span>"+this._getMeasurementString()+"</span>"});this._markerAarrys[this._markerAarrys.length-1].setIcon(E);var D=LTMap.marker(this._markerAarrys[G].getLatLng(),{icon:new LTMap.DivIcon({iconAnchor:[20,10],className:"finish_distance",html:"<span>x</span>",}),zIndexOffset:30000}).addTo(this._markerGroupTemp)}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},clear:function(){if(this._tempLayerGroup){this._tempLayerGroup.clearLayers();this.i=0}},_getTooltipText:function(){var E=this.options.showLength,F,D;if(this._markers.length===0){F={text:"单击地图确定起点"}}else{D=E?this._getMeasurementString():"";if(this._markers.length===1){F={text:"单击地图继续测距",subtext:D}}else{F={text:"双击地图或者单击最后一个点结束",subtext:D}}}return F},_fireCreatedEvent:function(){if(!this.i){this.i=0}var D=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);D.id=this.i;if(!this._tempLayerGroup){this._tempLayerGroup=LTMap.layerGroup()}var E=this;this._markerGroupTemp.eachLayer(function(H){var K=H._latlng;var G=H.options.icon.options.className;var F=H._icon.innerHTML;var N=H.options.zIndexOffset;var J,I;if(LTMap.Browser.ie){J=parseInt(H._icon.currentStyle.marginLeft);I=parseInt(H._icon.currentStyle.marginTop)}else{J=H._icon.offsetLeft;I=H._icon.offsetTop}var L=H._icon.offsetHeight;var O=H._icon.offsetWidth;var M=LTMap.marker(K,{icon:new LTMap.DivIcon({className:G,iconAnchor:[-J,-I],html:F,iconSize:[L,O]}),zIndexOffset:N});M.id=E.i;if(F=="<span>x</span>"||F=="<SPAN>x</SPAN>"){M.on("click",function(){E._tempLayerGroup.eachLayer(function(P){if(P.id==M.id){E._tempLayerGroup.removeLayer(P)}})})}E._tempLayerGroup.addLayer(M)});this._tempLayerGroup.addLayer(D);this.type=LTMap.MeasureDistance.TYPE;LTMap.Draw.Feature.prototype._fireCreatedEvent.call(this,this._tempLayerGroup);this.i++}});LTMap.SimpleShape={};LTMap.Draw.SimpleShape=LTMap.Draw.Feature.extend({options:{repeatMode:false},initialize:function(E,D){this._endLabelText=LTMap.drawLocal.draw.handlers.simpleshape.tooltip.end;LTMap.Draw.Feature.prototype.initialize.call(this,E,D)},addHooks:function(){LTMap.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._mapDraggable=this._map.dragging.enabled();if(this._mapDraggable){this._map.dragging.disable()}this._container.style.cursor="crosshair";this._tooltip.updateContent({text:this._initialLabelText});this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this)}},removeHooks:function(){LTMap.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._mapDraggable){this._map.dragging.enable()}this._container.style.cursor="";this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this);LTMap.DomEvent.off(A,"mouseup",this._onMouseUp,this);if(this._shape){this._map.removeLayer(this._shape);delete this._shape}}this._isDrawing=false},_onMouseDown:function(D){this._isDrawing=true;this._startLatLng=D.latlng;LTMap.DomEvent.on(A,"mouseup",this._onMouseUp,this).preventDefault(D.originalEvent)},_onMouseMove:function(E){var D=E.latlng;this._tooltip.updatePosition(D);if(this._isDrawing){this._tooltip.updateContent({text:this._endLabelText});this._drawShape(D)}},_onMouseUp:function(){if(this._shape){this._fireCreatedEvent()}this.disable();if(this.options.repeatMode){this.enable()}}});LTMap.Draw.Rectangle=LTMap.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true}},initialize:function(E,D){this.type=LTMap.Draw.Rectangle.TYPE;this._initialLabelText=LTMap.drawLocal.draw.handlers.rectangle.tooltip.start;LTMap.Draw.SimpleShape.prototype.initialize.call(this,E,D)},_drawShape:function(D){if(!this._shape){this._shape=new LTMap.Rectangle(new LTMap.LatLngBounds(this._startLatLng,D),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setBounds(new LTMap.LatLngBounds(this._startLatLng,D))}},open:function(){this.enable()},close:function(){this.disable()},_fireCreatedEvent:function(){var D=new LTMap.Rectangle(this._shape.getBounds(),this.options.shapeOptions);LTMap.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,D)}});LTMap.Draw.RectangleZoom=LTMap.Draw.SimpleShape.extend({statics:{TYPE:"rectangleZoom"},options:{zoom_in:true,shapeOptions:{stroke:true,color:"#004a80",weight:2,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:false}},initialize:function(E,D){this.type="rectangleZoom";this._endLabelText=LTMap.drawLocal.draw.handlers.rectangleZoom.tooltip.end;this._initialLabelText=LTMap.drawLocal.draw.handlers.rectangleZoom.tooltip.start;LTMap.Draw.SimpleShape.prototype.initialize.call(this,E,D)},_drawShape:function(D){if(!this._shape){this._shape=new LTMap.Rectangle(new LTMap.LatLngBounds(this._startLatLng,D),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setBounds(new LTMap.LatLngBounds(this._startLatLng,D))}},_fireCreatedEvent:function(){var D=new LTMap.Rectangle(this._shape.getBounds(),this.options.shapeOptions);this.type=LTMap.Draw.RectangleZoom.TYPE;LTMap.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,D)},open:function(){this.enable()},close:function(){this.disable()},_onMouseUp:function(){if(this.options.zoom_in){this._map.fitBounds(this._shape.getBounds())}else{var D=this._shape.getBounds().getCenter();var E=this._map.getZoom();this._map.setView(D,E-1)}if(this._shape){this._fireCreatedEvent()}this.disable();this.enable()}});LTMap.Draw.Circle=LTMap.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true},showRadius:false,metric:true},initialize:function(E,D){this.type=LTMap.Draw.Circle.TYPE;this._initialLabelText=LTMap.drawLocal.draw.handlers.circle.tooltip.start;LTMap.Draw.SimpleShape.prototype.initialize.call(this,E,D)},_drawShape:function(D){if(!this._shape){this._shape=new LTMap.Circle(this._startLatLng,this._startLatLng.distanceTo(D),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setRadius(this._startLatLng.distanceTo(D))}},open:function(){this.enable()},close:function(){this.disable()},_fireCreatedEvent:function(){var D=new LTMap.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);LTMap.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,D)},_onMouseMove:function(H){var E=H.latlng,F=this.options.showRadius,G=this.options.metric,D;this._tooltip.updatePosition(E);if(this._isDrawing){this._drawShape(E);D=this._shape.getRadius().toFixed(1);this._tooltip.updateContent({text:this._endLabelText,subtext:F?"半径: "+LTMap.GeometryUtil.readableDistance(D,G):""})}}});LTMap.Draw.Marker=LTMap.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new LTMap.Icon.Default(),repeatMode:false,zIndexOffset:2000},initialize:function(E,D){this.type=LTMap.Draw.Marker.TYPE;LTMap.Draw.Feature.prototype.initialize.call(this,E,D)},addHooks:function(){LTMap.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._tooltip.updateContent({text:LTMap.drawLocal.draw.handlers.marker.tooltip.start});if(!this._mouseMarker){this._mouseMarker=LTMap.marker(this._map.getCenter(),{icon:LTMap.divIcon({className:"ltmap-mouse-draw-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("click",this._onClick,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this)}},removeHooks:function(){LTMap.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._marker){this._marker.off("click",this._onClick,this);this._map.off("click",this._onClick,this).removeLayer(this._marker);delete this._marker}this._mouseMarker.off("click",this._onClick,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._map.off("mousemove",this._onMouseMove,this)}},_onMouseMove:function(E){var D=E.latlng;this._tooltip.updatePosition(D);this._mouseMarker.setLatLng(D);if(!this._marker){this._marker=new LTMap.Marker(D,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset});this._marker.on("click",this._onClick,this);this._map.on("click",this._onClick,this).addLayer(this._marker)}else{D=this._mouseMarker.getLatLng();this._marker.setLatLng(D)}},_onClick:function(){this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},open:function(){this.enable()},close:function(){this.disable()},_fireCreatedEvent:function(){var D=new LTMap.Marker(this._marker.getLatLng(),{icon:this.options.icon,draggable:this.options.draggable,innerTag:this.options.innerTag});LTMap.Draw.Feature.prototype._fireCreatedEvent.call(this,D)}});LTMap.Edit=LTMap.Edit||{};LTMap.Edit.Poly=LTMap.Handler.extend({options:{icon:new LTMap.DivIcon({iconSize:new LTMap.Point(8,8),className:"ltmap-div-icon ltmap-editing-icon"})},initialize:function(D,E){this._poly=D;LTMap.setOptions(this,E)},addHooks:function(){if(this._poly._map){if(!this._markerGroup){this._initMarkers()}this._poly._map.addLayer(this._markerGroup)}},removeHooks:function(){if(this._poly._map){this._poly._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers}},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new LTMap.LayerGroup()}this._markers=[];var J=this._poly._latlngs,H,I,D,E;for(H=0,D=J.length;H<D;H++){E=this._createMarker(J[H],H);E.on("click",this._onMarkerClick,this);this._markers.push(E)}var G,F;for(H=0,I=D-1;H<D;I=H++){if(H===0&&!(LTMap.Polygon&&(this._poly instanceof LTMap.Polygon))){continue}G=this._markers[I];F=this._markers[H];this._createMiddleMarker(G,F);this._updatePrevNext(G,F)}},_createMarker:function(D,F){var E=new LTMap.Marker(D,{draggable:true,icon:this.options.icon});E._origLatLng=D;E._index=F;E.on("drag",this._onMarkerDrag,this);E.on("dragend",this._fireEdit,this);this._markerGroup.addLayer(E);return E},_removeMarker:function(D){var E=D._index;this._markerGroup.removeLayer(D);this._markers.splice(E,1);this._poly.spliceLatLngs(E,1);this._updateIndexes(E,-1);D.off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("click",this._onMarkerClick,this)},_fireEdit:function(){this._poly.edited=true;this._poly.fire("edit")},_onMarkerDrag:function(E){var D=E.target;LTMap.extend(D._origLatLng,D._latlng);if(D._middleLeft){D._middleLeft.setLatLng(this._getMiddleLatLng(D._prev,D))}if(D._middleRight){D._middleRight.setLatLng(this._getMiddleLatLng(D,D._next))}this._poly.redraw()},_onMarkerClick:function(F){var E=LTMap.Polygon&&(this._poly instanceof LTMap.Polygon)?4:3,D=F.target;if(this._poly._latlngs.length<E){return}this._removeMarker(D);this._updatePrevNext(D._prev,D._next);if(D._middleLeft){this._markerGroup.removeLayer(D._middleLeft)}if(D._middleRight){this._markerGroup.removeLayer(D._middleRight)}if(D._prev&&D._next){this._createMiddleMarker(D._prev,D._next)}else{if(!D._prev){D._next._middleLeft=null}else{if(!D._next){D._prev._middleRight=null}}}this._fireEdit()},_updateIndexes:function(E,D){this._markerGroup.eachLayer(function(F){if(F._index>E){F._index+=D}})},_createMiddleMarker:function(E,G){var D=this._getMiddleLatLng(E,G),H=this._createMarker(D),J,I,F;H.setOpacity(0.6);E._middleRight=G._middleLeft=H;I=function(){var K=G._index;H._index=K;H.off("click",J,this).on("click",this._onMarkerClick,this);D.lat=H.getLatLng().lat;D.lng=H.getLatLng().lng;this._poly.spliceLatLngs(K,0,D);this._markers.splice(K,0,H);H.setOpacity(1);this._updateIndexes(K,1);G._index++;this._updatePrevNext(E,H);this._updatePrevNext(H,G);this._poly.fire("editstart")};F=function(){H.off("dragstart",I,this);H.off("dragend",F,this);this._createMiddleMarker(E,H);this._createMiddleMarker(H,G)};J=function(){I.call(this);F.call(this);this._fireEdit()};H.on("click",J,this).on("dragstart",I,this).on("dragend",F,this);this._markerGroup.addLayer(H)},_updatePrevNext:function(D,E){if(D){D._next=E}if(E){E._prev=D}},_getMiddleLatLng:function(E,F){var H=this._poly._map,D=H.project(E.getLatLng()),G=H.project(F.getLatLng());return H.unproject(D._add(G)._divideBy(2))}});LTMap.Polyline.addInitHook(function(){if(this.editing){return}if(LTMap.Edit.Poly){this.editing=new LTMap.Edit.Poly(this);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});LTMap.Edit=LTMap.Edit||{};LTMap.Edit.SimpleShape=LTMap.Handler.extend({options:{moveIcon:new LTMap.DivIcon({iconSize:new LTMap.Point(8,8),className:"ltmap-div-icon ltmap-editing-icon ltmap-edit-move"}),resizeIcon:new LTMap.DivIcon({iconSize:new LTMap.Point(8,8),className:"ltmap-div-icon ltmap-editing-icon ltmap-edit-resize"})},initialize:function(D,E){this._shape=D;LTMap.Util.setOptions(this,E)},addHooks:function(){if(this._shape._map){this._map=this._shape._map;if(!this._markerGroup){this._initMarkers()}this._map.addLayer(this._markerGroup)}},removeHooks:function(){if(this._shape._map){this._unbindMarker(this._moveMarker);for(var D=0,E=this._resizeMarkers.length;D<E;D++){this._unbindMarker(this._resizeMarkers[D])}this._resizeMarkers=null;this._map.removeLayer(this._markerGroup);delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new LTMap.LayerGroup()}this._createMoveMarker();this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(D,E){var F=new LTMap.Marker(D,{draggable:true,icon:E,zIndexOffset:10});this._bindMarker(F);this._markerGroup.addLayer(F);return F},_bindMarker:function(D){D.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this)},_unbindMarker:function(D){D.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this)},_onMarkerDragStart:function(E){var D=E.target;D.setOpacity(0);this._shape.fire("editstart")},_fireEdit:function(){this._shape.edited=true;this._shape.fire("edit")},_onMarkerDrag:function(F){var D=F.target,E=D.getLatLng();if(D===this._moveMarker){this._move(E)}else{this._resize(E)}this._shape.redraw()},_onMarkerDragEnd:function(E){var D=E.target;D.setOpacity(1);this._fireEdit()},_move:function(){},_resize:function(){}});LTMap.Edit=LTMap.Edit||{};LTMap.Edit.Rectangle=LTMap.Edit.SimpleShape.extend({_createMoveMarker:function(){var D=this._shape.getBounds(),E=D.getCenter();this._moveMarker=this._createMarker(E,this.options.moveIcon)},_createResizeMarker:function(){var E=this._getCorners();this._resizeMarkers=[];for(var D=0,F=E.length;D<F;D++){this._resizeMarkers.push(this._createMarker(E[D],this.options.resizeIcon));this._resizeMarkers[D]._cornerIndex=D}},_onMarkerDragStart:function(F){LTMap.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,F);var G=this._getCorners(),D=F.target,E=D._cornerIndex;this._oppositeCorner=G[(E+2)%4];this._toggleCornerMarkers(0,E)},_onMarkerDragEnd:function(G){var D=G.target,E,F;if(D===this._moveMarker){E=this._shape.getBounds();F=E.getCenter();D.setLatLng(F)}this._toggleCornerMarkers(1);this._repositionCornerMarkers();LTMap.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,G)},_move:function(H){var G=this._shape.getLatLngs(),I=this._shape.getBounds(),E=I.getCenter(),K,J=[];for(var D=0,F=G.length;D<F;D++){K=[G[D].lat-E.lat,G[D].lng-E.lng];J.push([H.lat+K[0],H.lng+K[1]])}this._shape.setLatLngs(J);this._repositionCornerMarkers()},_resize:function(D){var E;this._shape.setBounds(LTMap.latLngBounds(D,this._oppositeCorner));E=this._shape.getBounds();this._moveMarker.setLatLng(E.getCenter())},_getCorners:function(){var E=this._shape.getBounds(),H=E.getNorthWest(),D=E.getNorthEast(),F=E.getSouthEast(),G=E.getSouthWest();return[H,D,F,G]},_toggleCornerMarkers:function(D){for(var E=0,F=this._resizeMarkers.length;E<F;E++){this._resizeMarkers[E].setOpacity(D)}},_repositionCornerMarkers:function(){var E=this._getCorners();for(var D=0,F=this._resizeMarkers.length;D<F;D++){this._resizeMarkers[D].setLatLng(E[D])}}});LTMap.Rectangle.addInitHook(function(){if(LTMap.Edit.Rectangle){this.editing=new LTMap.Edit.Rectangle(this);if(this.options.editable){this.editing.enable()}}});LTMap.Edit=LTMap.Edit||{};LTMap.Edit.Circle=LTMap.Edit.SimpleShape.extend({_createMoveMarker:function(){var D=this._shape.getLatLng();this._moveMarker=this._createMarker(D,this.options.moveIcon)},_createResizeMarker:function(){var D=this._shape.getLatLng(),E=this._getResizeMarkerPoint(D);this._resizeMarkers=[];this._resizeMarkers.push(this._createMarker(E,this.options.resizeIcon))},_getResizeMarkerPoint:function(D){var E=this._shape._radius*Math.cos(Math.PI/4),F=this._map.project(D);return this._map.unproject([F.x+E,F.y-E])},_move:function(D){var E=this._getResizeMarkerPoint(D);this._resizeMarkers[0].setLatLng(E);this._shape.setLatLng(D)},_resize:function(E){var F=this._moveMarker.getLatLng(),D=F.distanceTo(E);this._shape.setRadius(D)}});LTMap.Circle.addInitHook(function(){if(LTMap.Edit.Circle){this.editing=new LTMap.Edit.Circle(this);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});LTMap.LatLngUtil={cloneLatLngs:function(F){var E=[];for(var D=0,G=F.length;D<G;D++){E.push(this.cloneLatLng(F[D]))}return E},cloneLatLng:function(D){return LTMap.latLng(D.lat,D.lng)}};LTMap.GeometryUtil=LTMap.extend(LTMap.GeometryUtil||{},{geodesicArea:function(J){var D=J.length,E=0,I=LTMap.LatLng.DEG_TO_RAD,H,F;if(D>2){for(var G=0;G<D;G++){H=J[G];F=J[(G+1)%D];E+=((F.lng-H.lng)*I)*(2+Math.sin(H.lat*I)+Math.sin(F.lat*I))}E=E*6378137*6378137/2}return Math.abs(E)},readableArea:function(D,F){var E;if(F){if(D>=1000000){E=(D/1000000).toFixed(2)+" 平方公里"}else{E=D.toFixed(0)+" 平方米"}}return E},readableDistance:function(E,F){var D;if(F){if(E>1000){D=(E/1000).toFixed(2)+" 公里"}else{D=Math.ceil(E)+" 米"}}else{E*=1.09361;if(E>1760){D=(E/1760).toFixed(2)+" 米"}else{D=(E/1760).toFixed(2)+" 米"}}return D}});LTMap.Util.extend(LTMap.LineUtil,{segmentsIntersect:function(G,F,E,D){return this._checkCounterclockwise(G,E,D)!==this._checkCounterclockwise(F,E,D)&&this._checkCounterclockwise(G,F,E)!==this._checkCounterclockwise(G,F,D)},_checkCounterclockwise:function(F,E,D){return(D.y-F.y)*(E.x-F.x)>(E.y-F.y)*(D.x-F.x)}});LTMap.Polyline.include({intersects:function(){var F=this._originalPoints,D=F?F.length:0,E,H,G;if(this._tooFewPointsForIntersection()){return false}for(E=D-1;E>=3;E--){H=F[E-1];G=F[E];if(this._lineSegmentsIntersectsRange(H,G,E-2)){return true}}return false},newLatLngIntersects:function(D,E){if(!this._map){return false}return this.newPointIntersects(this._map.latLngToLayerPoint(D),E)},newPointIntersects:function(I,F){var H=this._originalPoints,D=H?H.length:0,G=H?H[D-1]:null,E=D-2;if(this._tooFewPointsForIntersection(1)){return false}return this._lineSegmentsIntersectsRange(G,I,E,F?1:0)},_tooFewPointsForIntersection:function(E){var F=this._originalPoints,D=F?F.length:0;D+=E||0;return !this._originalPoints||D<=3},_lineSegmentsIntersectsRange:function(G,E,I,K){var F=this._originalPoints,H,D;K=K||0;for(var J=I;J>K;J--){H=F[J-1];D=F[J];if(LTMap.LineUtil.segmentsIntersect(G,E,H,D)){return true}}return false}});LTMap.Polygon.include({intersects:function(){var G,H=this._originalPoints,D,I,F,E;if(this._tooFewPointsForIntersection()){return false}G=LTMap.Polyline.prototype.intersects.call(this);if(G){return true}D=H.length;I=H[0];F=H[D-1];E=D-2;return this._lineSegmentsIntersectsRange(F,I,E,1)}});LTMap.Control.Draw=LTMap.Control.extend({options:{position:"topleft",draw:{},edit:false},initialize:function(E){if(LTMap.version<"1.0"){throw new Error("LTMap 版本过低")}LTMap.Control.prototype.initialize.call(this,E);var F,D;this._toolbars={};if(LTMap.DrawToolbar&&this.options.draw){D=new LTMap.DrawToolbar(this.options.draw);F=LTMap.stamp(D);this._toolbars[F]=D;this._toolbars[F].on("enable",this._toolbarEnabled,this)}if(LTMap.EditToolbar&&this.options.edit){D=new LTMap.EditToolbar(this.options.edit);F=LTMap.stamp(D);this._toolbars[F]=D;this._toolbars[F].on("enable",this._toolbarEnabled,this)}},onAdd:function(H){var D=LTMap.DomUtil.create("div","ltmap-draw"),E=false,I="ltmap-draw-toolbar-top",G;for(var F in this._toolbars){if(this._toolbars.hasOwnProperty(F)){G=this._toolbars[F].addToolbar(H);if(G){if(!E){if(!LTMap.DomUtil.hasClass(G,I)){LTMap.DomUtil.addClass(G.childNodes[0],I)}E=true}D.appendChild(G)}}}return D},onRemove:function(){for(var D in this._toolbars){if(this._toolbars.hasOwnProperty(D)){this._toolbars[D].removeToolbar()}}},setDrawingOptions:function(E){for(var D in this._toolbars){if(this._toolbars[D] instanceof LTMap.DrawToolbar){this._toolbars[D].setOptions(E)}}},_toolbarEnabled:function(F){var D=""+LTMap.stamp(F.target);for(var E in this._toolbars){if(this._toolbars.hasOwnProperty(E)&&E!==D){this._toolbars[E].disable()}}}});LTMap.Map.mergeOptions({drawControlTooltips:true,drawControl:false});LTMap.Map.addInitHook(function(){if(this.options.drawControl){this.drawControl=new LTMap.Control.Draw();this.addControl(this.drawControl)}});LTMap.Toolbar=LTMap.Class.extend({includes:[LTMap.Mixin.Events],initialize:function(D){LTMap.setOptions(this,D);this._modes={};this._actionButtons=[];this._activeMode=null},enabled:function(){return this._activeMode!==null},disable:function(){if(!this.enabled()){return}this._activeMode.handler.disable()},addToolbar:function(H){var D=LTMap.DomUtil.create("div","ltmap-draw-section"),I=0,F=this._toolbarClass||"",E=this.getModeHandlers(H),G;this._toolbarContainer=LTMap.DomUtil.create("div","ltmap-draw-toolbar ltmap-bar");this._map=H;for(G=0;G<E.length;G++){if(E[G].enabled){this._initModeHandler(E[G].handler,this._toolbarContainer,I++,F,E[G].title)}}if(!I){return}this._lastButtonIndex=--I;this._actionsContainer=LTMap.DomUtil.create("ul","ltmap-draw-actions");D.appendChild(this._toolbarContainer);D.appendChild(this._actionsContainer);return D},removeToolbar:function(){for(var D in this._modes){if(this._modes.hasOwnProperty(D)){this._disposeButton(this._modes[D].button,this._modes[D].handler.enable,this._modes[D].handler);this._modes[D].handler.disable();this._modes[D].handler.off("enabled",this._handlerActivated,this).off("disabled",this._handlerDeactivated,this)}}this._modes={};for(var E=0,F=this._actionButtons.length;E<F;E++){this._disposeButton(this._actionButtons[E].button,this._actionButtons[E].callback,this)}this._actionButtons=[];this._actionsContainer=null},_initModeHandler:function(F,E,I,H,D){var G=F.type;this._modes[G]={};this._modes[G].handler=F;this._modes[G].button=this._createButton({title:D,className:H+"-"+G,container:E,callback:this._modes[G].handler.enable,context:this._modes[G].handler});this._modes[G].buttonIndex=I;this._modes[G].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_createButton:function(E){var D=LTMap.DomUtil.create("a",E.className||"",E.container);D.href="#";if(E.text){D.innerHTML=E.text}if(E.title){D.title=E.title}LTMap.DomEvent.on(D,"click",LTMap.DomEvent.stopPropagation).on(D,"mousedown",LTMap.DomEvent.stopPropagation).on(D,"dblclick",LTMap.DomEvent.stopPropagation).on(D,"click",LTMap.DomEvent.preventDefault).on(D,"click",E.callback,E.context);return D},_disposeButton:function(D,E){LTMap.DomEvent.off(D,"click",LTMap.DomEvent.stopPropagation).off(D,"mousedown",LTMap.DomEvent.stopPropagation).off(D,"dblclick",LTMap.DomEvent.stopPropagation).off(D,"click",LTMap.DomEvent.preventDefault).off(D,"click",E)},_handlerActivated:function(D){this.disable();this._activeMode=this._modes[D.handler];LTMap.DomUtil.addClass(this._activeMode.button,"ltmap-draw-toolbar-button-enabled");this._showActionsToolbar();this.fire("enable")},_handlerDeactivated:function(){this._hideActionsToolbar();LTMap.DomUtil.removeClass(this._activeMode.button,"ltmap-draw-toolbar-button-enabled");this._activeMode=null;this.fire("disable")},_createActions:function(L){var E=this._actionsContainer,J=this.getActions(L),F=J.length,K,H,I,G;for(H=0,I=this._actionButtons.length;H<I;H++){this._disposeButton(this._actionButtons[H].button,this._actionButtons[H].callback)}this._actionButtons=[];while(E.firstChild){E.removeChild(E.firstChild)}for(var D=0;D<F;D++){if("enabled" in J[D]&&!J[D].enabled){continue}K=LTMap.DomUtil.create("li","",E);G=this._createButton({title:J[D].title,text:J[D].text,container:K,callback:J[D].callback,context:J[D].context});this._actionButtons.push({button:G,callback:J[D].callback})}},_showActionsToolbar:function(){var F=this._activeMode.buttonIndex,E=this._lastButtonIndex,D=this._activeMode.button.offsetTop-1;this._createActions(this._activeMode.handler);this._actionsContainer.style.top=D+"px";if(F===0){LTMap.DomUtil.addClass(this._toolbarContainer,"ltmap-draw-toolbar-notop");LTMap.DomUtil.addClass(this._actionsContainer,"ltmap-draw-actions-top")}if(F===E){LTMap.DomUtil.addClass(this._toolbarContainer,"ltmap-draw-toolbar-nobottom");LTMap.DomUtil.addClass(this._actionsContainer,"ltmap-draw-actions-bottom")}this._actionsContainer.style.display="block"},_hideActionsToolbar:function(){this._actionsContainer.style.display="none";LTMap.DomUtil.removeClass(this._toolbarContainer,"ltmap-draw-toolbar-notop");LTMap.DomUtil.removeClass(this._toolbarContainer,"ltmap-draw-toolbar-nobottom");LTMap.DomUtil.removeClass(this._actionsContainer,"ltmap-draw-actions-top");LTMap.DomUtil.removeClass(this._actionsContainer,"ltmap-draw-actions-bottom")}});LTMap.Tooltip=LTMap.Class.extend({initialize:function(D){this._map=D;this._popupPane=D._panes.popupPane;this._container=D.options.drawControlTooltips?LTMap.DomUtil.create("div","ltmap-draw-tooltip",this._popupPane):null;this._singleLineLabel=false},dispose:function(){if(this._container){this._popupPane.removeChild(this._container);this._container=null}},updateContent:function(D){if(!this._container){return this}D.subtext=D.subtext||"";if(D.subtext.length===0&&!this._singleLineLabel){LTMap.DomUtil.addClass(this._container,"ltmap-draw-tooltip-single");this._singleLineLabel=true}else{if(D.subtext.length>0&&this._singleLineLabel){LTMap.DomUtil.removeClass(this._container,"ltmap-draw-tooltip-single");this._singleLineLabel=false}}this._container.innerHTML=(D.subtext.length>0?'<span class="ltmap-draw-tooltip-subtext">'+D.subtext+"</span><br />":"")+"<span>"+D.text+"</span>";return this},updatePosition:function(D){var F=this._map.latLngToLayerPoint(D),E=this._container;if(this._container){E.style.visibility="inherit";LTMap.DomUtil.setPosition(E,F)}return this},showAsError:function(){if(this._container){LTMap.DomUtil.addClass(this._container,"ltmap-error-draw-tooltip")}return this},removeError:function(){if(this._container){LTMap.DomUtil.removeClass(this._container,"ltmap-error-draw-tooltip")}return this}});LTMap.DrawToolbar=LTMap.Toolbar.extend({options:{polyline:{},polygon:{},rectangle:{},circle:{},marker:{}},initialize:function(E){for(var D in this.options){if(this.options.hasOwnProperty(D)){if(E[D]){E[D]=LTMap.extend({},this.options[D],E[D])}}}this._toolbarClass="ltmap-draw-draw";LTMap.Toolbar.prototype.initialize.call(this,E)},getModeHandlers:function(D){return[{enabled:this.options.polyline,handler:new LTMap.Draw.Polyline(D,this.options.polyline),title:LTMap.drawLocal.draw.toolbar.buttons.polyline},{enabled:this.options.polygon,handler:new LTMap.Draw.Polygon(D,this.options.polygon),title:LTMap.drawLocal.draw.toolbar.buttons.polygon},{enabled:this.options.rectangle,handler:new LTMap.Draw.Rectangle(D,this.options.rectangle),title:LTMap.drawLocal.draw.toolbar.buttons.rectangle},{enabled:this.options.circle,handler:new LTMap.Draw.Circle(D,this.options.circle),title:LTMap.drawLocal.draw.toolbar.buttons.circle},{enabled:this.options.marker,handler:new LTMap.Draw.Marker(D,this.options.marker),title:LTMap.drawLocal.draw.toolbar.buttons.marker}]},getActions:function(D){return[{enabled:D.deleteLastVertex,title:LTMap.drawLocal.draw.toolbar.undo.title,text:LTMap.drawLocal.draw.toolbar.undo.text,callback:D.deleteLastVertex,context:D},{title:LTMap.drawLocal.draw.toolbar.actions.title,text:LTMap.drawLocal.draw.toolbar.actions.text,callback:this.disable,context:this}]},setOptions:function(E){LTMap.setOptions(this,E);for(var D in this._modes){if(this._modes.hasOwnProperty(D)&&E.hasOwnProperty(D)){this._modes[D].handler.setOptions(E[D])}}}});LTMap.EditToolbar=LTMap.Toolbar.extend({options:{edit:{selectedPathOptions:{color:"#fe57a1",opacity:0.6,dashArray:"10, 10",fill:true,fillColor:"#fe57a1",fillOpacity:0.1}},remove:{},featureGroup:null},initialize:function(D){if(D.edit){if(typeof D.edit.selectedPathOptions==="undefined"){D.edit.selectedPathOptions=this.options.edit.selectedPathOptions}D.edit=LTMap.extend({},this.options.edit,D.edit)}if(D.remove){D.remove=LTMap.extend({},this.options.remove,D.remove)}this._toolbarClass="ltmap-draw-edit";LTMap.Toolbar.prototype.initialize.call(this,D);this._selectedFeatureCount=0},getModeHandlers:function(D){var E=this.options.featureGroup;return[{enabled:this.options.edit,handler:new LTMap.EditToolbar.Edit(D,{featureGroup:E,selectedPathOptions:this.options.edit.selectedPathOptions}),title:LTMap.drawLocal.edit.toolbar.buttons.edit},{enabled:this.options.remove,handler:new LTMap.EditToolbar.Delete(D,{featureGroup:E}),title:LTMap.drawLocal.edit.toolbar.buttons.remove}]},getActions:function(){return[{title:LTMap.drawLocal.edit.toolbar.actions.save.title,text:LTMap.drawLocal.edit.toolbar.actions.save.text,callback:this._save,context:this},{title:LTMap.drawLocal.edit.toolbar.actions.cancel.title,text:LTMap.drawLocal.edit.toolbar.actions.cancel.text,callback:this.disable,context:this}]},addToolbar:function(E){var D=LTMap.Toolbar.prototype.addToolbar.call(this,E);this._checkDisabled();this.options.featureGroup.on("layeradd layerremove",this._checkDisabled,this);return D},removeToolbar:function(){this.options.featureGroup.off("layeradd layerremove",this._checkDisabled,this);LTMap.Toolbar.prototype.removeToolbar.call(this)},disable:function(){if(!this.enabled()){return}this._activeMode.handler.revertLayers();LTMap.Toolbar.prototype.disable.call(this)},_save:function(){this._activeMode.handler.save();this._activeMode.handler.disable()},_checkDisabled:function(){var F=this.options.featureGroup,E=F.getLayers().length!==0,D;if(this.options.edit){D=this._modes[LTMap.EditToolbar.Edit.TYPE].button;if(E){LTMap.DomUtil.removeClass(D,"ltmap-disabled")}else{LTMap.DomUtil.addClass(D,"ltmap-disabled")}D.setAttribute("title",E?LTMap.drawLocal.edit.toolbar.buttons.edit:LTMap.drawLocal.edit.toolbar.buttons.editDisabled)}if(this.options.remove){D=this._modes[LTMap.EditToolbar.Delete.TYPE].button;if(E){LTMap.DomUtil.removeClass(D,"ltmap-disabled")}else{LTMap.DomUtil.addClass(D,"ltmap-disabled")}D.setAttribute("title",E?LTMap.drawLocal.edit.toolbar.buttons.remove:LTMap.drawLocal.edit.toolbar.buttons.removeDisabled)}}});LTMap.EditToolbar.Edit=LTMap.Handler.extend({statics:{TYPE:"edit"},includes:LTMap.Mixin.Events,initialize:function(E,D){LTMap.Handler.prototype.initialize.call(this,E);this._selectedPathOptions=D.selectedPathOptions;this._featureGroup=D.featureGroup;if(!(this._featureGroup instanceof LTMap.FeatureGroup)){throw new Error("options.featureGroup must be a LTMap.FeatureGroup")}this._uneditedLayerProps={};this.type=LTMap.EditToolbar.Edit.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:editstart",{handler:this.type});LTMap.Handler.prototype.enable.call(this);this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this)},disable:function(){if(!this._enabled){return}this._featureGroup.off("layeradd",this._enableLayerEdit,this).off("layerremove",this._disableLayerEdit,this);LTMap.Handler.prototype.disable.call(this);this._map.fire("draw:editstop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var D=this._map;if(D){D.getContainer().focus();this._featureGroup.eachLayer(this._enableLayerEdit,this);this._tooltip=new LTMap.Tooltip(this._map);this._tooltip.updateContent({text:LTMap.drawLocal.edit.handlers.edit.tooltip.text,subtext:LTMap.drawLocal.edit.handlers.edit.tooltip.subtext});this._map.on("mousemove",this._onMouseMove,this)}},removeHooks:function(){if(this._map){this._featureGroup.eachLayer(this._disableLayerEdit,this);this._uneditedLayerProps={};this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this)}},revertLayers:function(){this._featureGroup.eachLayer(function(D){this._revertLayer(D)},this)},save:function(){var D=new LTMap.LayerGroup();this._featureGroup.eachLayer(function(E){if(E.edited){D.addLayer(E);E.edited=false}});this._map.fire("draw:edited",{layers:D})},_backupLayer:function(D){var E=LTMap.Util.stamp(D);if(!this._uneditedLayerProps[E]){if(D instanceof LTMap.Polyline||D instanceof LTMap.Polygon||D instanceof LTMap.Rectangle){this._uneditedLayerProps[E]={latlngs:LTMap.LatLngUtil.cloneLatLngs(D.getLatLngs())}}else{if(D instanceof LTMap.Circle){this._uneditedLayerProps[E]={latlng:LTMap.LatLngUtil.cloneLatLng(D.getLatLng()),radius:D.getRadius()}}else{if(D instanceof LTMap.Marker){this._uneditedLayerProps[E]={latlng:LTMap.LatLngUtil.cloneLatLng(D.getLatLng())}}}}}},_revertLayer:function(D){var E=LTMap.Util.stamp(D);D.edited=false;if(this._uneditedLayerProps.hasOwnProperty(E)){if(D instanceof LTMap.Polyline||D instanceof LTMap.Polygon||D instanceof LTMap.Rectangle){D.setLatLngs(this._uneditedLayerProps[E].latlngs)}else{if(D instanceof LTMap.Circle){D.setLatLng(this._uneditedLayerProps[E].latlng);D.setRadius(this._uneditedLayerProps[E].radius)}else{if(D instanceof LTMap.Marker){D.setLatLng(this._uneditedLayerProps[E].latlng)}}}}},_toggleMarkerHighlight:function(D){if(!D._icon){return}var E=D._icon;E.style.display="none";if(LTMap.DomUtil.hasClass(E,"ltmap-edit-marker-selected")){LTMap.DomUtil.removeClass(E,"ltmap-edit-marker-selected");this._offsetMarker(E,-4)}else{LTMap.DomUtil.addClass(E,"ltmap-edit-marker-selected");this._offsetMarker(E,4)}E.style.display=""},_offsetMarker:function(E,G){var F=parseInt(E.style.marginTop,10)-G,D=parseInt(E.style.marginLeft,10)-G;E.style.marginTop=F+"px";E.style.marginLeft=D+"px"},_enableLayerEdit:function(F){var D=F.layer||F.target||F,E=D instanceof LTMap.Marker,G;if(E&&!D._icon){return}this._backupLayer(D);if(this._selectedPathOptions){G=LTMap.Util.extend({},this._selectedPathOptions);if(E){this._toggleMarkerHighlight(D)}else{D.options.previousOptions=LTMap.Util.extend({dashArray:null},D.options);if(!(D instanceof LTMap.Circle)&&!(D instanceof LTMap.Polygon)&&!(D instanceof LTMap.Rectangle)){G.fill=false}D.setStyle(G)}}if(E){D.dragging.enable();D.on("dragend",this._onMarkerDragEnd)}else{D.editing.enable()}},_disableLayerEdit:function(E){var D=E.layer||E.target||E;D.edited=false;if(this._selectedPathOptions){if(D instanceof LTMap.Marker){this._toggleMarkerHighlight(D)}else{D.setStyle(D.options.previousOptions);delete D.options.previousOptions}}if(D instanceof LTMap.Marker){D.dragging.disable();D.off("dragend",this._onMarkerDragEnd,this)}else{D.editing.disable()}},_onMarkerDragEnd:function(E){var D=E.target;D.edited=true},_onMouseMove:function(D){this._tooltip.updatePosition(D.latlng)},_hasAvailableLayers:function(){return this._featureGroup.getLayers().length!==0}});LTMap.EditToolbar.Delete=LTMap.Handler.extend({statics:{TYPE:"remove"},includes:LTMap.Mixin.Events,initialize:function(E,D){LTMap.Handler.prototype.initialize.call(this,E);LTMap.Util.setOptions(this,D);this._deletableLayers=this.options.featureGroup;if(!(this._deletableLayers instanceof LTMap.FeatureGroup)){throw new Error("options.featureGroup must be a LTMap.FeatureGroup")}this.type=LTMap.EditToolbar.Delete.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:deletestart",{handler:this.type});LTMap.Handler.prototype.enable.call(this);this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this)},disable:function(){if(!this._enabled){return}this._deletableLayers.off("layeradd",this._enableLayerDelete,this).off("layerremove",this._disableLayerDelete,this);LTMap.Handler.prototype.disable.call(this);this._map.fire("draw:deletestop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var D=this._map;if(D){D.getContainer().focus();this._deletableLayers.eachLayer(this._enableLayerDelete,this);this._deletedLayers=new LTMap.layerGroup();this._tooltip=new LTMap.Tooltip(this._map);this._tooltip.updateContent({text:LTMap.drawLocal.edit.handlers.remove.tooltip.text});this._map.on("mousemove",this._onMouseMove,this)}},removeHooks:function(){if(this._map){this._deletableLayers.eachLayer(this._disableLayerDelete,this);this._deletedLayers=null;this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this)}},revertLayers:function(){this._deletedLayers.eachLayer(function(D){this._deletableLayers.addLayer(D)},this)},save:function(){this._map.fire("draw:deleted",{layers:this._deletedLayers})},_enableLayerDelete:function(E){var D=E.layer||E.target||E;D.on("click",this._removeLayer,this)},_disableLayerDelete:function(E){var D=E.layer||E.target||E;D.off("click",this._removeLayer,this);this._deletedLayers.removeLayer(D)},_removeLayer:function(E){var D=E.layer||E.target||E;this._deletableLayers.removeLayer(D);this._deletedLayers.addLayer(D)},_onMouseMove:function(D){this._tooltip.updatePosition(D.latlng)},_hasAvailableLayers:function(){return this._deletableLayers.getLayers().length!==0}})}(window,document));